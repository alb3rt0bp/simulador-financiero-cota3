<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Financiero - Proyecto Sepulcro 13</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-bg: #f8fafc;
            --color-card: #ffffff;
            --color-primary: #0f172a;
            --color-accent: #d97706;
            --color-text: #334155;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--color-bg); color: var(--color-text); }
        h1, h2, h3 { font-family: 'Playfair Display', serif; color: var(--color-primary); }

        input[type=range] { accent-color: #2563eb; height: 6px; border-radius: 5px; background: #e2e8f0; appearance: none; }
        input[type=range]::-webkit-slider-thumb { appearance: none; width: 18px; height: 18px; background: #2563eb; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        
        .table-container { overflow-x: auto; border-radius: 1rem; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; text-align: left; background: white; }
        th { background: #0f172a; color: white; padding: 1rem; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }
        td { padding: 1rem; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem; }
        tr:last-child td { border-bottom: none; }
        .negative { color: #dc2626; font-weight: 600; }
        .positive { color: #16a34a; font-weight: 600; }
        .input-box { background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.5rem; width: 100%; outline: none; font-weight: 600; }
        
        .param-label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .param-value { color: #2563eb; font-weight: 800; font-size: 0.9rem; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto space-y-8">
        
        <!-- CABECERA -->
        <header class="flex flex-col md:flex-row justify-between items-end gap-4 bg-white p-8 rounded-3xl shadow-sm border border-slate-200">
            <div>
                <h1 class="text-4xl font-black tracking-tight mb-2">SEPULCRO 13</h1>
                <p class="text-slate-500 font-medium uppercase text-xs tracking-widest">Control de Liquidez y Análisis de Autopromoción</p>
            </div>
            <div class="text-right">
                <p class="text-[10px] font-bold text-slate-400 uppercase">Presupuesto Ejecución Material (s/IVA)</p>
                <p class="text-3xl font-black text-blue-600">450.150,35 €</p>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- PANEL DE CONTROL (IZQUIERDA) -->
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm space-y-6">
                    <h3 class="text-lg font-bold italic border-b pb-2">Parámetros Hipoteca</h3>
                    
                    <div class="space-y-6">
                        <!-- Financiación LTV -->
                        <div>
                            <div class="param-label">
                                <label class="text-sm font-bold text-slate-700">Financiación (LTV)</label>
                                <span id="ltv-display" class="param-value">80%</span>
                            </div>
                            <input type="range" id="input-ltv" min="1" max="100" step="1" value="80" class="w-full">
                        </div>

                        <!-- Plazo -->
                        <div>
                            <div class="param-label">
                                <label class="text-sm font-bold text-slate-700">Plazo (Años)</label>
                                <span id="years-display" class="param-value">30 años</span>
                            </div>
                            <input type="range" id="input-years" min="10" max="35" step="1" value="30" class="w-full">
                        </div>

                        <!-- Interés -->
                        <div>
                            <div class="param-label">
                                <label class="text-sm font-bold text-slate-700">Tipo de Interés</label>
                                <span id="rate-display" class="param-value">3.50%</span>
                            </div>
                            <input type="range" id="input-rate" min="0" max="10" step="0.05" value="3.5" class="w-full">
                        </div>
                    </div>
                </div>

                <div class="bg-blue-600 p-6 rounded-3xl shadow-lg text-white space-y-2">
                    <p class="text-[10px] uppercase font-bold opacity-80">Cuota Mensual Estimada</p>
                    <p id="monthly-payment" class="text-3xl font-black">0,00 €</p>
                    <div class="pt-2 border-t border-blue-400/30 text-[10px] opacity-70">
                        Capital Prestado: <span id="loan-amt">0 €</span>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm space-y-4">
                    <h3 class="text-sm font-bold uppercase tracking-widest text-slate-400">Fondos Iniciales</h3>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">Tu Liquidez Disponible</label>
                        <input type="number" id="input-funds" value="160000" class="w-full text-2xl font-black p-2 bg-slate-50 border-b-2 border-blue-500 outline-none">
                    </div>
                    <div id="safety-margin" class="p-3 rounded-xl text-xs font-medium">
                        <!-- Recomendación dinámica -->
                    </div>
                </div>
            </div>

            <!-- TABLA GASTOS EXTRAS -->
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 bg-slate-900 text-white flex justify-between items-center">
                        <h3 class="font-bold italic">Gastos Adicionales de Autopromotor</h3>
                        <span class="text-[10px] opacity-60">FONDOS PROPIOS NECESARIOS</span>
                    </div>
                    <table class="text-xs">
                        <thead>
                            <tr class="bg-slate-100">
                                <th class="!text-slate-700 !bg-transparent">Concepto</th>
                                <th class="!text-slate-700 !bg-transparent text-right">Inversión Estimada</th>
                                <th class="!text-slate-700 !bg-transparent">Observaciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="font-bold">Arquitecto y Dirección</td>
                                <td class="text-right">28.500,00 €</td>
                                <td class="text-slate-400">Proyecto + DO + DEO</td>
                            </tr>
                            <tr>
                                <td class="font-bold">Licencia y Tasas</td>
                                <td class="text-right">18.000,00 €</td>
                                <td class="text-slate-400">ICIO + Tasa Urbanística</td>
                            </tr>
                            <tr>
                                <td class="font-bold">Seguros y Varios</td>
                                <td class="text-right">4.500,00 €</td>
                                <td class="text-slate-400">Todo Riesgo + OCT</td>
                            </tr>
                            <tr class="bg-slate-50 font-black">
                                <td>TOTAL PRE-OBRA</td>
                                <td class="text-right text-amber-600">51.000,00 €</td>
                                <td>No financiables habitualmente</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- TABLA FLUJO DE CAJA -->
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                        <h2 class="text-xl font-bold italic tracking-tight">Flujo de Caja y Desfase</h2>
                    </div>
                    <div class="table-container">
                        <table id="cashflow-table" class="text-[13px]">
                            <thead>
                                <tr>
                                    <th>Capítulo</th>
                                    <th class="text-right">Obra (PEM)</th>
                                    <th class="text-right">IVA (10%)</th>
                                    <th class="text-right">Pago Total</th>
                                    <th class="text-right">Reembolso LTV</th>
                                    <th class="text-right">Liquidez</th>
                                </tr>
                            </thead>
                            <tbody id="table-body"></tbody>
                            <tfoot class="bg-slate-100 font-bold border-t-2 border-slate-200">
                                <tr id="table-footer"></tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- NOTA SOBRE EL SKELETON -->
        <div class="bg-amber-50 border-l-4 border-amber-400 p-6 rounded-2xl flex items-start gap-4 shadow-sm">
            <div class="text-amber-500 text-2xl">⚠️</div>
            <div>
                <h4 class="text-amber-900 font-bold mb-1 italic">Análisis del "Skeleton" (Estructura)</h4>
                <p id="skeleton-text" class="text-amber-800 text-sm leading-relaxed"></p>
            </div>
        </div>

    </div>

    <script>
        const BASE_PEM = 450150.35;
        const GASTOS_EXTRAS = 51000;

        const chapters = [
            { id: "00", name: "Demoliciones", cost: 17000 },
            { id: "01", name: "Mov. Tierras", cost: 11820 },
            { id: "02", name: "Saneamiento", cost: 5574 },
            { id: "03", name: "Cimentación", cost: 75075 },
            { id: "04", name: "Estructura (Skeleton)", cost: 62448 },
            { id: "05", name: "Albañilería", cost: 30596 },
            { id: "06", name: "Cubiertas", cost: 14572 },
            { id: "07", name: "Rev. y Falsos Techos", cost: 26728 },
            { id: "08", name: "Aislamientos", cost: 15476 },
            { id: "09", name: "Solados y Alicatados", cost: 56055 },
            { id: "10-12", name: "Instalaciones (Elec/Font/Cal)", cost: 45300 },
            { id: "13-14", name: "Carpinterías (Ext/Int)", cost: 57000 },
            { id: "15-17", name: "Acabados y Varios", cost: 23000 },
            { id: "18", name: "Limpieza", cost: 9506.35 }
        ];

        function fmt(n) { return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n); }

        function update() {
            const ltv = parseInt(document.getElementById('input-ltv').value);
            const years = parseInt(document.getElementById('input-years').value);
            const rate = parseFloat(document.getElementById('input-rate').value);
            const initialFunds = parseFloat(document.getElementById('input-funds').value) || 0;
            
            // Actualizar etiquetas visuales
            document.getElementById('ltv-display').innerText = ltv + '%';
            document.getElementById('years-display').innerText = years + ' años';
            document.getElementById('rate-display').innerText = rate.toFixed(2) + '%';

            const factor = ltv / 100;
            const loanAmount = BASE_PEM * factor;
            
            // Cálculo Cuota (fórmula amortización francesa)
            const monthlyRate = (rate / 100) / 12;
            const numPayments = years * 12;
            
            let cuota = 0;
            if (monthlyRate > 0) {
                cuota = (loanAmount * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -numPayments));
            } else {
                cuota = loanAmount / numPayments;
            }

            document.getElementById('monthly-payment').innerText = fmt(cuota);
            document.getElementById('loan-amt').innerText = fmt(loanAmount);

            let currentLiquidity = initialFunds - GASTOS_EXTRAS;
            
            const tableBody = document.getElementById('table-body');
            let html = '';
            let totals = { pem: 0, iva: 0, total: 0, banco: 0 };

            chapters.forEach(ch => {
                const iva = ch.cost * 0.10;
                const totalPagoCh = ch.cost + iva;
                const reembolsoBanco = ch.cost * factor;
                
                currentLiquidity = currentLiquidity - totalPagoCh + reembolsoBanco;

                totals.pem += ch.cost;
                totals.iva += iva;
                totals.total += totalPagoCh;
                totals.banco += reembolsoBanco;

                html += `
                    <tr>
                        <td class="font-medium text-slate-800">${ch.name}</td>
                        <td class="text-right">${fmt(ch.cost)}</td>
                        <td class="text-right text-slate-400">${fmt(iva)}</td>
                        <td class="text-right font-semibold">${fmt(totalPagoCh)}</td>
                        <td class="text-right text-blue-600">${fmt(reembolsoBanco)}</td>
                        <td class="text-right ${currentLiquidity < 0 ? 'negative' : 'positive'}">
                            ${fmt(currentLiquidity)}
                        </td>
                    </tr>
                `;

                if (ch.id === "04") {
                    const diff = totalPagoCh - reembolsoBanco;
                    document.getElementById('skeleton-text').innerHTML = `La fase de <strong>Estructura</strong> exige un desembolso neto de fondos propios de <strong>${fmt(diff)}</strong> (IVA incluido). El banco solo te devuelve el ${ltv}% del PEM neto.`;
                }
            });

            tableBody.innerHTML = html;
            document.getElementById('table-footer').innerHTML = `
                <td class="p-4">TOTAL OBRA</td>
                <td class="p-4 text-right">${fmt(totals.pem)}</td>
                <td class="p-4 text-right">${fmt(totals.iva)}</td>
                <td class="p-4 text-right">${fmt(totals.total)}</td>
                <td class="p-4 text-right text-blue-700">${fmt(totals.banco)}</td>
                <td class="p-4 text-right ${currentLiquidity < 0 ? 'negative' : 'positive'}">${fmt(currentLiquidity)}</td>
            `;

            const fundsNeeded = (BASE_PEM * (1 - factor)) + (BASE_PEM * 0.10) + GASTOS_EXTRAS;
            const marginBox = document.getElementById('safety-margin');
            if (initialFunds < fundsNeeded) {
                marginBox.className = "p-3 rounded-xl text-xs font-medium bg-red-50 text-red-700 border border-red-100";
                marginBox.innerHTML = `⚠️ Fondos insuficientes. Se recomiendan al menos <strong>${fmt(fundsNeeded)}</strong> para cubrir el ${100-ltv}% no financiado, el IVA completo y los gastos técnicos iniciales.`;
            } else {
                marginBox.className = "p-3 rounded-xl text-xs font-medium bg-green-50 text-green-700 border border-green-100";
                marginBox.innerHTML = `✅ Dispones de un colchón de seguridad de ${fmt(initialFunds - fundsNeeded)} sobre el mínimo aconsejado.`;
            }
        }

        ['input-ltv', 'input-years', 'input-rate', 'input-funds'].forEach(id => {
            document.getElementById(id).addEventListener('input', update);
        });

        window.onload = update;
    </script>
</body>
</html>