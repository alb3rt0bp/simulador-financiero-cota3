<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Financiero - Proyecto Sepulcro 13</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-bg: #f8fafc;
            --color-card: #ffffff;
            --color-primary: #0f172a;
            --color-accent: #d97706;
            --color-text: #334155;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--color-bg); color: var(--color-text); }
        h1, h2, h3 { font-family: 'Playfair Display', serif; color: var(--color-primary); }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: auto;
            height: 350px;
        }

        .card {
            background-color: var(--color-card);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        input[type=range] { width: 100%; accent-color: var(--color-accent); }

        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background-color: #f1f5f9;
            text-align: left;
            padding: 0.75rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #64748b;
        }
        
        td {
            padding: 0.75rem;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.875rem;
        }

        .highlight-row {
            background-color: #fffbeb;
        }

        .paid-badge {
            background-color: #dcfce7;
            color: #166534;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .pending-badge {
            background-color: #fef9c3;
            color: #854d0e;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .numeric-input {
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.5rem;
            width: 100%;
            font-weight: 700;
            font-size: 1.5rem;
            color: #059669;
            text-align: center;
        }
        
        .numeric-input:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }
    </style>
</head>
<body class="antialiased">

    <header class="bg-slate-900 text-white py-10 px-6">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center">
            <div class="text-center md:text-left">
                <h1 class="text-4xl font-bold mb-2">Simulador Sepulcro 13</h1>
                <p class="text-slate-400">Presupuesto de Contrata (Cotatres): 450.150‚Ç¨ + IVA.</p>
            </div>
            <div class="mt-6 md:mt-0 bg-slate-800 p-4 rounded-lg border border-slate-700 text-center md:text-right">
                <span class="text-xs uppercase text-slate-500 font-bold block mb-1">Inversi√≥n Total Estimada (Obra + Gastos)</span>
                <span class="text-3xl font-bold text-amber-500" id="header-total">0 ‚Ç¨</span>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
        
        <!-- SECTION 1: CONTROLS & DYNAMIC KPIs -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Sliders Panel -->
            <div class="card space-y-6 border-t-4 border-amber-500">
                <h3 class="text-xl font-bold border-b pb-2">Par√°metros Bancarios</h3>
                
                <div>
                    <div class="flex justify-between mb-2">
                        <label class="text-sm font-semibold">Financiaci√≥n sobre Contrata: <span id="val-ltv">80</span>%</label>
                    </div>
                    <input type="range" id="input-ltv" min="50" max="100" value="80">
                </div>

                <div>
                    <div class="flex justify-between mb-2">
                        <label class="text-sm font-semibold">Plazo Amortizaci√≥n: <span id="val-years">25</span> a√±os</label>
                    </div>
                    <input type="range" id="input-years" min="5" max="35" value="25">
                </div>

                <div>
                    <div class="flex justify-between mb-2">
                        <label class="text-sm font-semibold">Tipo de Inter√©s (E): <span id="val-rate">3.5</span>%</label>
                    </div>
                    <input type="range" id="input-rate" min="0.5" max="7.0" step="0.1" value="3.5">
                </div>

                <div class="pt-4 bg-slate-50 p-4 rounded-lg text-center">
                    <span class="text-xs uppercase text-slate-500 font-bold">Cuota Mensual Estimada</span>
                    <p class="text-4xl font-black text-slate-900" id="display-monthly">0 ‚Ç¨</p>
                </div>
            </div>

            <!-- Dynamic Results -->
            <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="card flex flex-col justify-center items-center text-center">
                    <h3 class="text-sm uppercase text-slate-400 font-bold">Capital Concedido</h3>
                    <p class="text-4xl font-bold text-blue-600 my-2" id="display-loan">0 ‚Ç¨</p>
                    <p class="text-xs text-slate-500">M√°ximo financiable estimado</p>
                </div>
                
                <div class="card flex flex-col justify-between items-center text-center border-l-4 border-emerald-500">
                    <h3 class="text-sm uppercase text-slate-400 font-bold mb-2">Tus Ahorros Totales (‚Ç¨)</h3>
                    <input type="number" id="input-own-manual" class="numeric-input" value="185000">
                    <div class="mt-3">
                        <span class="text-[10px] uppercase text-slate-400 font-bold">Aportaci√≥n Propia Necesaria</span>
                        <p class="text-lg font-semibold text-slate-700" id="display-own-recommended">0 ‚Ç¨</p>
                    </div>
                </div>

                <div class="card md:col-span-2 flex flex-col md:flex-row items-center justify-between gap-4 bg-slate-50">
                    <div class="max-w-md">
                        <h3 class="text-lg font-bold">Estado de Tesorer√≠a</h3>
                        <p class="text-sm text-slate-600" id="liquidity-msg">Calculando...</p>
                        <p class="text-[10px] text-slate-400 mt-1 uppercase font-bold">Incluye IVA, Gastos e Inversi√≥n ya realizada.</p>
                    </div>
                    <div class="text-center px-6 py-3 rounded-xl" id="liquidity-status-box">
                        <span class="text-xs uppercase font-bold block opacity-70">Margen de Liquidez</span>
                        <span class="text-2xl font-black" id="display-balance">0 ‚Ç¨</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION: EXPENSES CONTROL -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 card">
                <h3 class="text-xl font-bold mb-4">Gastos de Autopromoci√≥n (Soft Costs)</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Concepto</th>
                                <th>Importe (‚Ç¨)</th>
                                <th>Estado</th>
                                <th>Observaciones</th>
                            </tr>
                        </thead>
                        <tbody id="expenses-body">
                            <!-- JS Inject -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card flex flex-col justify-center bg-slate-50">
                <h4 class="text-xs uppercase text-slate-400 font-bold mb-4 text-center">Resumen Gastos T√©cnicos e Impuestos</h4>
                <div class="space-y-4">
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="text-sm">Ya Pagado:</span>
                        <span class="font-bold text-emerald-600" id="total-paid">0 ‚Ç¨</span>
                    </div>
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="text-sm">Pendiente:</span>
                        <span class="font-bold text-amber-600" id="total-pending">0 ‚Ç¨</span>
                    </div>
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="text-sm font-semibold">IVA Obra (10%):</span>
                        <span class="font-bold text-slate-700" id="total-iva-obra">0 ‚Ç¨</span>
                    </div>
                    <div class="flex justify-between items-center pt-2">
                        <span class="text-sm font-bold">Total Gastos + IVA:</span>
                        <span class="font-black text-slate-900" id="total-expenses-sum">0 ‚Ç¨</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION: CASHFLOW TABLE -->
        <section class="card overflow-hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Planificaci√≥n de Flujo de Caja (Obras)</h3>
                <span class="text-xs bg-amber-100 text-amber-800 px-3 py-1 rounded-full font-bold">Basado en Contrata Cotatres</span>
            </div>
            <div class="table-container">
                <table id="cashflow-table">
                    <thead>
                        <tr>
                            <th>Cap√≠tulo del Presupuesto</th>
                            <th>Coste Contrata (‚Ç¨)</th>
                            <th>Adelanto Promotor (100%)</th>
                            <th>Disposici√≥n Banco (%)</th>
                            <th>Impacto en Caja</th>
                        </tr>
                    </thead>
                    <tbody id="cashflow-body"></tbody>
                </table>
            </div>
        </section>

        <!-- SECTION: CHARTS -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="card">
                <h3 class="text-xl font-bold mb-4">Estructura de la Financiaci√≥n</h3>
                <div class="chart-container">
                    <canvas id="fundingChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h3 class="text-xl font-bold mb-4">Distribuci√≥n del Presupuesto de Contrata</h3>
                <div id="categoryChart" class="w-full h-[300px]"></div>
            </div>
        </section>

    </main>

    <script>
        const BASE_PEM = 450150.35;
        const IVA_RATE = 0.10;
        const IVA_OBRA = BASE_PEM * IVA_RATE;

        // Listado actualizado de gastos t√©cnicos, licencias y suministros
        const softCosts = [
            { name: "Proyecto Arquitectura (Ejecuci√≥n)", cost: 14500, paid: true, obs: "Visado y entregado" },
            { name: "Licencia de Obra Mayor", cost: 8200, paid: true, obs: "Abonada al Ayuntamiento" },
            { name: "Estudio Geot√©cnico y Topogr√°fico", cost: 1800, paid: true, obs: "Realizado" },
            { name: "Consumos (Agua/Elec/Contador)", cost: 7185.67, paid: false, obs: "Provisi√≥n obra" },
            { name: "Declaraci√≥n de Obra Nueva", cost: 5400.00, paid: false, obs: "Notar√≠a y Registro" },
            { name: "Direcci√≥n de Obra (Arquitecto)", cost: 6500, paid: false, obs: "A pagar por hitos" },
            { name: "Direcci√≥n de Ejecuci√≥n (Aparejador)", cost: 4500, paid: false, obs: "A pagar por hitos" },
            { name: "Entradas Agua / Electricidad", cost: 2076.75, paid: false, obs: "Acometidas finales" },
            { name: "OCT", cost: 1864.91, paid: false, obs: "Control T√©cnico Externo" },
            { name: "Seguro Decenal", cost: 1671.86, paid: false, obs: "Garant√≠a 10 a√±os" },
            { name: "Coordinaci√≥n Seguridad y Salud", cost: 1200, paid: false, obs: "Durante obra" },
            { name: "Seguro Todo Riesgo Construcci√≥n", cost: 950, paid: false, obs: "P√≥liza obligatoria" }
        ];

        const chapters = [
            { name: "Movimiento Tierras y Cimentaci√≥n", cost: 22400 },
            { name: "Saneamiento y Drenajes", cost: 12250 },
            { name: "Cerramientos (Termoarcilla)", cost: 35500 },
            { name: "ESTRUCTURA HORMIG√ìN (Skeleton)", cost: 68500 },
            { name: "Cubiertas e Impermeabilizaci√≥n", cost: 25100 },
            { name: "Revestimientos y Pavimentos", cost: 42600 },
            { name: "Carpinter√≠a Exterior RPT", cost: 44200 },
            { name: "Instalaciones y Aerotermia", cost: 58800 },
            { name: "Cocina y Mobiliario Fijo", cost: 29300 },
            { name: "Exteriores, Jard√≠n y Varios", cost: 111500.35 } 
        ];

        const inLtv = document.getElementById('input-ltv');
        const inYears = document.getElementById('input-years');
        const inRate = document.getElementById('input-rate');
        const inOwnManual = document.getElementById('input-own-manual');
        const expensesBody = document.getElementById('expenses-body');

        let fundingChart;

        function updateExpensesTable() {
            expensesBody.innerHTML = '';
            let paidSum = 0;
            let pendingSum = 0;

            softCosts.forEach(item => {
                if (item.paid) paidSum += item.cost;
                else pendingSum += item.cost;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="font-medium text-slate-700">${item.name}</td>
                    <td class="font-bold">${item.cost.toLocaleString('es-ES')} ‚Ç¨</td>
                    <td><span class="${item.paid ? 'paid-badge' : 'pending-badge'}">${item.paid ? 'PAGADO' : 'PENDIENTE'}</span></td>
                    <td class="text-slate-400 italic text-xs">${item.obs}</td>
                `;
                expensesBody.appendChild(row);
            });

            document.getElementById('total-paid').innerText = paidSum.toLocaleString('es-ES') + ' ‚Ç¨';
            document.getElementById('total-pending').innerText = pendingSum.toLocaleString('es-ES') + ' ‚Ç¨';
            document.getElementById('total-iva-obra').innerText = IVA_OBRA.toLocaleString('es-ES') + ' ‚Ç¨';
            document.getElementById('total-expenses-sum').innerText = (paidSum + pendingSum + IVA_OBRA).toLocaleString('es-ES') + ' ‚Ç¨';
            
            return { paidSum, pendingSum };
        }

        function calculate() {
            const { paidSum, pendingSum } = updateExpensesTable();
            
            const ltvVal = inLtv.value;
            const ltv = ltvVal / 100;
            const years = inYears.value;
            const rate = (inRate.value / 100) / 12;
            const n = years * 12;

            const principal = BASE_PEM * ltv;
            const monthly = principal * (rate * Math.pow(1 + rate, n)) / (Math.pow(1 + rate, n) - 1);
            
            // Inversi√≥n total = Obra + IVA + Gastos t√©cnicos totales
            const totalProjectCost = BASE_PEM + IVA_OBRA + (paidSum + pendingSum);
            document.getElementById('header-total').innerText = totalProjectCost.toLocaleString('es-ES', {maximumFractionDigits:0}) + ' ‚Ç¨';

            // Lo que el banco NO presta (IVA + Gastos + 20% Obra si LTV es 80)
            const recommendedOwn = totalProjectCost - principal;
            const actualOwn = parseFloat(inOwnManual.value) || 0;
            
            // Balance considerando ahorros actuales vs necesidades totales
            const balance = actualOwn - recommendedOwn;

            document.getElementById('val-ltv').innerText = ltvVal;
            document.getElementById('val-years').innerText = years;
            document.getElementById('val-rate').innerText = inRate.value;

            document.getElementById('display-monthly').innerText = (isNaN(monthly) ? 0 : monthly).toLocaleString('es-ES', { maximumFractionDigits: 0 }) + ' ‚Ç¨';
            document.getElementById('display-loan').innerText = principal.toLocaleString('es-ES', { maximumFractionDigits: 0 }) + ' ‚Ç¨';
            document.getElementById('display-own-recommended').innerText = recommendedOwn.toLocaleString('es-ES', { maximumFractionDigits: 0 }) + ' ‚Ç¨';
            
            document.getElementById('display-balance').innerText = (balance >= 0 ? "+" : "") + balance.toLocaleString('es-ES', { maximumFractionDigits: 0 }) + ' ‚Ç¨';
            
            const boxLiq = document.getElementById('liquidity-status-box');
            const outLiqMsg = document.getElementById('liquidity-msg');
            
            if (balance >= 0) {
                boxLiq.className = "text-center px-6 py-3 rounded-xl bg-emerald-100 text-emerald-800";
                outLiqMsg.innerText = "Tesorer√≠a saneada incluyendo consumos, OCT y seguro decenal.";
            } else {
                boxLiq.className = "text-center px-6 py-3 rounded-xl bg-red-100 text-red-800";
                outLiqMsg.innerText = "D√©ficit detectado. Considerar aportaci√≥n extra para cubrir gastos t√©cnicos.";
            }

            updateCharts(principal, actualOwn);
            updateCashflowTable(ltv);
        }

        function updateCashflowTable(ltvPercent) {
            const body = document.getElementById('cashflow-body');
            body.innerHTML = '';
            chapters.forEach(chap => {
                const reimburse = chap.cost * ltvPercent;
                const net = chap.cost - reimburse;
                const isSkeleton = chap.name.includes("ESTRUCTURA");
                const row = document.createElement('tr');
                if (isSkeleton) row.className = 'highlight-row';
                row.innerHTML = `
                    <td class="font-medium">${isSkeleton ? 'üèóÔ∏è ' : ''}${chap.name}</td>
                    <td>${chap.cost.toLocaleString('es-ES')} ‚Ç¨</td>
                    <td class="text-red-600">-${chap.cost.toLocaleString('es-ES')} ‚Ç¨</td>
                    <td class="text-blue-600">+${reimburse.toLocaleString('es-ES', {maximumFractionDigits:0})} ‚Ç¨</td>
                    <td class="font-bold">${net.toLocaleString('es-ES', {maximumFractionDigits:0})} ‚Ç¨</td>
                `;
                body.appendChild(row);
            });
        }

        function updateCharts(loan, own) {
            if(fundingChart) {
                fundingChart.data.datasets[0].data = [loan, own];
                fundingChart.update();
            }
        }

        function init() {
            fundingChart = new Chart(document.getElementById('fundingChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Financiaci√≥n Bancaria', 'Fondos Propios'],
                    datasets: [{ data: [0, 0], backgroundColor: ['#2563eb', '#10b981'], borderWidth: 0 }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });

            const pLabels = ["Presupuesto Total", ...chapters.map(c => c.name)];
            const pParents = ["", ...chapters.map(c => "Presupuesto Total")];
            const pValues = [BASE_PEM, ...chapters.map(c => c.cost)];
            Plotly.newPlot('categoryChart', [{
                type: "treemap", labels: pLabels, parents: pParents, values: pValues, marker: { colorscale: 'Greens' }
            }], { margin: {t:0, l:0, r:0, b:0}, paper_bgcolor: 'rgba(0,0,0,0)' }, {responsive: true, displayModeBar: false});

            [inLtv, inYears, inRate, inOwnManual].forEach(el => el.addEventListener('input', calculate));
            calculate();
        }

        window.onload = init;
    </script>
</body>
</html>